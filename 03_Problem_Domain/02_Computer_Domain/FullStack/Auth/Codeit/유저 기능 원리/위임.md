## 졉근 권한 위임과 OAuth
"만약 다른 서비스에 있는 데이터를  가져오고 와서 사용하고싶다면?"
- 페이스북에서 파일을 받아 사용중인 서비스에 업로드한다.
- 사용중인 서비스에 페이스북 키를 사용하여 자동화한다.(위험이 따름 만약 사용중인 서비스가 키를 빼돌린다면??)
	- 이럴때 OAuth사용


접근 권한 위임: 한  서비스가 다른 서비스에 있는 보호된 리소스에 대한 접근 권한을 위임하거나 받는 기능
OAuth(Open Authorizaiton): 개방형 접근 권한 위임 표준
	- 이메일 , 비번같은  민감정보를 제3자에게 넘기지않으면서
	- 보호된 리소스에 접근할수있게 해주는 절차같은것이다.

## OAuth 주제와 설정
"스케쥴링 기능 추가 - 구글 캘린더에서 받아올수있게 하고싶습니다."
유저 - 백엔드 - 프론트엔드 - 인가 서버 -  리소스 서버
- 인가 서버에서  Client ID와 Secret을 받는다. 그냥  우리 서버를 구글에 회원가입시키는것과 비슷
- 이러한 인가서버에서 받은 것들을 우리 서버 백엔드에 집어넣는다.
- Scope(인가 서버로부터 넘겨받으려는 권한의 범위)
	- 스케쥴 데이터를 읽어올 수 있다 (read)
	- 스케쥴 데이터를 읽고,수정,삭제,생성까지 할수있다(CRUD)
	- 유저가 갖는 모든 권한을 다 갖는다.
	- 서로 필요한것만 넘겨주도록 정하는것이다.

## OAuth 워크플로우
특정  목표를 이루기위한 특정 작업순서
![[Pasted image 20251004192221.png]]
접근 권한을 특정 방식으로 주고 받기 위해서 각 주체들이 해야되는 작업들과 그 순서
다른 뛰어난 개발자들이 만들고, 구글이나 페이스북 같은 서비스에서 인가 서버에 대한것을 만들어놔서
우리 서버에서 개발할것만 챙기면 되는 느낌이다.

![[Pasted image 20251004192429.png]]
Authorization Code: 유저 본인이 권한 위임을 원하다는 걸 확인시켜주는 데이터
![[Pasted image 20251004192701.png]]
## OpenID Connect(OIDC)
![[Pasted image 20251004192906.png]]
이럴때 사용한다.
![[Pasted image 20251004192929.png]]
OIDC프로바이더에서 Client ID와  Secret을 발급받아 백엔드에 저장
스코프 설정 : 성과 이름,프로필 사진,생년월일

워크플로우
![[Pasted image 20251004193109.png]]
> 이부분 까지는 OAuth와 동일

다음 부터 나오는 access token은 유저의 신원정보가 담긴다.(JWT형식으로 발급받는다.)![[Pasted image 20251004193322.png]]

## 다양한 OAuth/OpenID 플로우
Authorization Code  flow에 대해
Implicit flow보다 인증 코드 플로우가 더권장될까?

Implicit Code Flow 에서 Client Secret은 사용되지 않고, Client ID는 프론트엔드에 저장
Authorization Code Flow에서는 프론트엔드에게 authorization code를 발행

Imploct Code Flow 에서는 엑세스 토큰 자체를 리턴 받는다. OIDC를 사용하고 있다면 여기서 바로 id token을 리턴받는다.  프론트에서 다시 백엔드로 전달후 백엔드는 이걸 사용해서 리소스 서버에 접근

사실 Implict Flow을 사용하면 훨씬간단한데 왜?
-> 안정성  때문

사실 access token을 갖고 있으면 리소스 서버에 여러 작업들을 요청할 수 있고, id token은 유저의 개인 정보를 담고 있기 때문에 믿을 수 없는 사람에게 유출되면 안 되는데요. Implicit 플로우를 사용하면 access token이 클라이언트 코드와 브라우저, 그리고 브라우저가 실행되고 있는 개인 컴퓨터에까지 노출되기 때문에 중간에 누군가가 가로챌 수 있는 가능성이 있습니다.

또한 프론트에  저장된것은 노출되기가 쉽다.
우리 사이트가 아닌 다른 사이트에 access token을  발급하는 것도 꽤 위험하다.

Authorization Code를 사용하면 어떨까요? 프론트앤드는 Authorization code만 갖고 있고, Client Secret은 오직 백엔드 서버에만 저장돼있습니다. Authorization code의 유일한 기능은 인가 서버에 보내서 access나 id 토큰을 발행 받는 건데요. 이때 Client ID와 Secret을 함께 보내야 하잖아요? 이 두 데이터는 프론트앤드에 저장하지 않기 때문에 누군가 악의를 갖고 클라이언트 쪽에서 Authorization Code를 가로챈다고 해도 사용할 수 없습니다.

Hybrid 플로우, Client-Credentials 플로우 등 다양한 방식들을 통해 사용할 수 있는데요. 대부분의 상황에서는 Authorization Code 플로우가 가장 권장되고 실제로 많이 사용

## 문제
OAuth에는 Authorization Code 플로우, Implicit 플로우 등 여러 플로우들이 있습니다.

리소스 서버의 보호된 리소스에 대한 접근 권한을 받이 위해서는 access token이 필요합니다. Authorization Code 플로우에서는 백엔드 서버가 authorization code와 함께 client ID, client secret을 인가 서버에 보내야지 access token을 받을 수 있습니다.

OpenID Connect도 OAuth와 마찬가지로 서비스를 사용하기 전에 먼저 OpenID 프로바이더에서 설정을 해줘야 합니다.